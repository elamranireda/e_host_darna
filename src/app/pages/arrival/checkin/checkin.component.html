<!-- Affichage des erreurs - PRIORITÉ ABSOLUE -->
<app-error-message 
  *ngIf="hasError"
  [errorCode]="errorCode"
  (retry)="retryOperation()">
</app-error-message>

<!-- Contenu principal - affiché uniquement s'il n'y a pas d'erreur -->
<div *ngIf="!hasError && accessInstructions() as item" class="flex flex-col md:flex-row md:items-start">
  <div class="flex-auto">
    <h2 class="title mt-6 mb-4 flex items-center">
    <span
      @scaleIn
      class="w-10 h-10 rounded-full text-primary-600 mr-3 flex items-center justify-center bg-primary-600/10">
      <mat-icon class="icon-sm" svgIcon="mat:vertical_split"></mat-icon>
    </span>
      <span @fadeInRight class="block">{{item.title}}</span>
    </h2>

    <!-- État de chargement -->
    <div *ngIf="propertyStore.loading()" class="flex flex-col items-center justify-center py-12">
      <mat-spinner [diameter]="40"></mat-spinner>
      <p class="mt-4 text-hint">{{ 'COMMON.LOADING' | translate }}</p>
    </div>

    <!-- Message de bienvenue -->
    <app-checkin-welcome 
      *ngIf="!propertyStore.loading() && item.messages" 
      [item]="item.messages" 
      class="sm:col-span-2">
    </app-checkin-welcome>

    <!-- Contenu principal -->
    <div *ngIf="!propertyStore.loading()" @fadeInSlideUp class="card overflow-hidden">
      <mat-vertical-stepper #verticalStepper="matVerticalStepper" [linear]="false" [selectedIndex]="0">
        <ng-template matStepperIcon="edit">
          <mat-icon svgIcon="mat:done_all"></mat-icon>
        </ng-template>

        <ng-template matStepperIcon="done">
          <mat-icon svgIcon="mat:done_all"></mat-icon>
        </ng-template>

        <mat-step *ngFor="let instruction of getSortedInstructions(item); let i = index" [completed]="true" [editable]="true">
          <ng-template matStepLabel>
            {{instruction.title}} - {{ 'CHECKIN.STEP' | translate }} {{instruction.step}}
            <small *ngIf="instruction.type === InstructionType.ACCESS_MODE" class="text-hint ml-2">{{ 'ACCESS_TYPE.ACCESS' | translate }}</small>
            <small *ngIf="instruction.type === InstructionType.IDENTITY_CHECK" class="text-hint ml-2">{{ 'ACCESS_TYPE.IDENTITY' | translate }}</small>
            <small *ngIf="instruction.type === InstructionType.ARRIVAL_INSTRUCTION" class="text-hint ml-2">{{ 'ACCESS_TYPE.ARRIVAL' | translate }}</small>
          </ng-template>
          
          <!-- Indicateur de progression -->
          <!-- Suppression de la barre de progression -->
          
          <div class="mt-2 mb-4">
            <div *ngIf="instruction.videoUrl && instruction.images && instruction.images.length > 0" 
                class="flex justify-start mb-4 media-toggle">
              <div class="media-toggle w-full flex flex-col xs:flex-row rounded-lg overflow-hidden">
                <button mat-flat-button [color]="!isShowingVideo(instruction) ? 'primary' : ''" 
                        class="flex-1 text-sm sm:text-base py-3 flex items-center justify-center" (click)="toggleMediaType(instruction, false)">
                  <mat-icon svgIcon="mat:photo_library" class="mr-2 icon-sm sm:icon-md"></mat-icon>
                  <span class="whitespace-nowrap">{{ 'MEDIA.SHOW_IMAGES' | translate }}</span>
                </button>
                <button mat-flat-button [color]="isShowingVideo(instruction) ? 'primary' : ''" 
                        class="flex-1 text-sm sm:text-base py-3 flex items-center justify-center mt-2 xs:mt-0" (click)="toggleMediaType(instruction, true)">
                  <mat-icon svgIcon="mat:videocam" class="mr-2 icon-sm sm:icon-md"></mat-icon>
                  <span class="whitespace-nowrap">{{ 'MEDIA.SHOW_VIDEO' | translate }}</span>
                </button>
              </div>
            </div>
          
            <app-access-instruction-content
              [videoUrl]="shouldShowVideo(instruction) ? instruction.videoUrl : undefined"
              [imageUrls]="undefined">
              <p [innerHTML]="instruction.description" class="pt-1">
              </p>
              <div *ngFor="let i of instruction?.list" class="mt-4 flex items-center">
                <mat-icon class="mr-2" svgIcon="mat:check_circle"></mat-icon>
                <span class="body-2 cursor-pointer">{{i}}</span>
              </div>
              
              <!-- Advanced Gallery Component -->
              <div *ngIf="shouldShowImages(instruction) && instruction.images && instruction.images.length > 0" class="gallery-container mt-4">
                <h4 class="gallery-title flex items-center mb-3">
                  <mat-icon svgIcon="mat:photo_library" class="mr-2"></mat-icon>
                  {{ 'MEDIA.IMAGES' | translate }}
                </h4>
                
                <!-- Image thumbnails grid with sequential numbering -->
                <div class="thumbnails-grid grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2 mb-4">
                  <div *ngFor="let image of instruction.images; let i = index" 
                      class="thumbnail-item relative cursor-pointer rounded overflow-hidden shadow-sm hover:shadow transition-all duration-200"
                      (click)="openGallery(instruction, i)">
                      <img [src]="image" [alt]="'Image ' + (i+1)" loading="lazy" class="w-full h-auto object-cover aspect-square">
                      <div class="step-indicator absolute top-2 left-2 w-6 h-6 rounded-full bg-primary-600 text-white flex items-center justify-center text-xs font-medium">
                        {{i+1}}
                      </div>
                      <div class="thumbnail-overlay absolute inset-0 bg-black bg-opacity-20 opacity-0 hover:opacity-100 transition-opacity duration-200 flex items-center justify-center">
                        <button mat-icon-button class="bg-white bg-opacity-75 rounded-full">
                          <mat-icon svgIcon="mat:zoom_in"></mat-icon>
                        </button>
                      </div>
                  </div>
                </div>
              </div>
              
              <!-- Lightbox overlay -->
              <div *ngIf="lightboxOpen" class="lightbox-overlay fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-90">
                <div class="lightbox-container relative w-full h-full max-w-5xl mx-auto my-8 px-4">
                  <!-- Close button -->
                  <button (click)="closeGallery()" class="absolute top-4 right-4 z-10 bg-white rounded-full w-10 h-10 flex items-center justify-center shadow-lg" 
                          [attr.aria-label]="'MEDIA.CLOSE_GALLERY' | translate">
                    <mat-icon svgIcon="mat:close"></mat-icon>
                  </button>
                  
                  <!-- Navigation buttons -->
                  <button *ngIf="hasMultipleGalleryItems()"
                          (click)="navigate('prev')" 
                          class="absolute left-4 top-1/2 transform -translate-y-1/2 z-10 bg-white rounded-full w-12 h-12 flex items-center justify-center shadow-lg"
                          [attr.aria-label]="'NAVIGATION.PREVIOUS' | translate">
                    <mat-icon svgIcon="mat:chevron_left"></mat-icon>
                  </button>
                  <button *ngIf="hasMultipleGalleryItems()"
                          (click)="navigate('next')" 
                          class="absolute right-4 top-1/2 transform -translate-y-1/2 z-10 bg-white rounded-full w-12 h-12 flex items-center justify-center shadow-lg"
                          [attr.aria-label]="'NAVIGATION.NEXT' | translate">
                    <mat-icon svgIcon="mat:chevron_right"></mat-icon>
                  </button>
                  
                  <!-- Main image -->
                  <div class="lightbox-main h-full flex flex-col justify-center">
                    <div class="image-container flex-1 flex items-center justify-center overflow-hidden">
                      <img *ngIf="hasGalleryItems()"
                          [src]="getCurrentImageSrc()" 
                          [alt]="getCurrentImageTitle()"
                          class="max-h-full max-w-full object-contain">
                    </div>
                    
                    <!-- Caption and sequence indicator -->
                    <div class="lightbox-caption mt-4 bg-white bg-opacity-10 p-4 rounded">
                      <div class="flex items-center mb-2">
                        <span class="step-badge bg-primary-600 text-white px-3 py-1 rounded-full text-sm font-medium">
                          {{ 'MEDIA.STEP' | translate }} {{currentImageIndex + 1}} / {{getGalleryItemsCount()}}
                        </span>
                        <h4 class="m-0 ml-3 text-white text-lg">
                          {{getCurrentImageTitle()}}
                        </h4>
                      </div>
                      <p class="text-white opacity-80 m-0">
                        {{getCurrentImageDescription()}}
                      </p>
                    </div>
                    
                    <!-- Thumbnail strip -->
                    <div *ngIf="hasMultipleGalleryItems()" 
                        class="thumbnail-strip flex overflow-x-auto py-4 mt-4 bg-white bg-opacity-5 rounded">
                      <div *ngFor="let item of getAllGalleryItems(); let i = index"
                          class="mx-2 cursor-pointer"
                          [class.opacity-50]="i !== currentImageIndex"
                          [class.ring-2]="i === currentImageIndex"
                          [class.ring-primary-500]="i === currentImageIndex"
                          (click)="currentImageIndex = i">
                        <div class="relative">
                          <img [src]="item.thumb" [alt]="'Thumbnail ' + item.order" class="h-16 w-16 object-cover rounded">
                          <div class="absolute -top-2 -right-2 w-6 h-6 rounded-full bg-primary-600 text-white flex items-center justify-center text-xs">
                            {{item.order}}
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Access Mode Item section -->
              <div *ngIf="isAccessModeItem(instruction)" class="py-4">
                <!-- N'affiche le conteneur de code que si methodType n'est pas KEY -->
                <div *ngIf="instruction?.methodType !== 'KEY'" class="access-code-container bg-primary-50 p-4 rounded-lg border-l-4 border-primary-500 my-4">
                  <div class="flex items-center justify-between">
                    <div class="flex items-center">
                      <mat-icon svgIcon="mat:vpn_key" class="text-primary-500 mr-2"></mat-icon>
                      <span class="font-medium">{{ 'ACCESS.CODE' | translate }}</span>
                    </div>
                    <div class="code-display px-2 flex items-center">
                      <span class="mr-4 font-mono text-xl tracking-wider" [class.blur-sm]="!visible">
                        {{instruction?.codeAccess?.code}}
                      </span>
                      <button (click)="togglePassword()" mat-icon-button type="button">
                        <mat-icon *ngIf="visible" svgIcon="mat:visibility"></mat-icon>
                        <mat-icon *ngIf="!visible" svgIcon="mat:visibility_off"></mat-icon>
                      </button>
                      <button mat-icon-button (click)="copyToClipboard(instruction?.codeAccess?.code)" 
                              matTooltip="{{ 'ACCESS.COPY_CODE' | translate }}"
                              class="ml-2">
                        <mat-icon svgIcon="mat:content_copy"></mat-icon>
                      </button>
                    </div>
                  </div>
                  <!-- N'affiche la date d'expiration que si elle est spécifiée -->
                  <div *ngIf="instruction?.codeAccess?.expiresAt" class="mt-2 text-hint text-sm">
                    <span>{{ 'ACCESS.CODE_EXPIRY' | translate }}: {{formatExpiryDate(instruction?.codeAccess?.expiresAt)}}</span>
                  </div>
                </div>
                
                
              </div>
              
              <!-- Identity Check Item section -->
              <div *ngIf="isIdentityCheckItem(instruction) && instruction.needToCheck" class="py-4">
                <a *ngIf="instruction.checkLink" 
                  [href]="instruction.checkLink" 
                  target="_blank" 
                  mat-raised-button 
                  color="primary">
                  {{ 'IDENTITY.VERIFY' | translate }}
                </a>
              </div>
              
              <!-- Arrival Instruction Item section -->
              <div *ngIf="isArrivalInstructionItem(instruction)" class="py-4">
                <!-- Specific content for arrival instructions if needed -->
              </div>
            </app-access-instruction-content>
          </div>
          
          <!-- Navigation buttons -->
          <div class="flex justify-between mt-6 navigation-actions">
            <button mat-button matStepperPrevious *ngIf="i > 0"
                    class="prev-button">
              <mat-icon class="mr-2" svgIcon="mat:arrow_back"></mat-icon>
              {{ 'NAVIGATION.PREVIOUS' | translate }}
            </button>
            <div class="flex-grow"></div>
            <button mat-raised-button color="primary" matStepperNext 
                    *ngIf="i < getSortedInstructions(item).length - 1"
                    class="next-button">
              {{ 'NAVIGATION.NEXT' | translate }}
              <mat-icon class="ml-2" svgIcon="mat:arrow_forward"></mat-icon>
            </button>
            <button mat-raised-button color="accent"
                    *ngIf="i === getSortedInstructions(item).length - 1"
                    class="complete-button whitespace-nowrap text-xs sm:text-sm"
                    (click)="completeCheckin()">
              <span>{{ 'CHECKIN.COMPLETE' | translate }}</span>
            </button>
          </div>
          
          <!-- Navigation mobile (visible seulement sur mobile) -->
          <div class="fixed bottom-0 left-0 right-0 bg-background py-2 px-4 shadow-up z-10 md:hidden border-t">
            <div class="flex justify-between navigation-actions">
              <button mat-mini-fab matStepperPrevious *ngIf="i > 0"
                      color="basic" aria-label="Previous">
                <mat-icon svgIcon="mat:arrow_back"></mat-icon>
              </button>
              <div class="flex-grow flex justify-center items-center">
                <span class="text-hint">{{instruction.step}}/{{getSortedInstructions(item).length}}</span>
              </div>
              <!-- Bouton de complétion spécial pour la dernière étape sur mobile -->
              <button *ngIf="i === getSortedInstructions(item).length - 1"
                      mat-mini-fab
                      color="accent"
                      (click)="completeCheckin()"
                      [attr.aria-label]="'CHECKIN.COMPLETE' | translate">
                <mat-icon svgIcon="mat:check_circle"></mat-icon>
              </button>
              <button mat-mini-fab matStepperNext 
                      *ngIf="i < getSortedInstructions(item).length - 1"
                      color="primary" aria-label="Next">
                <mat-icon svgIcon="mat:arrow_forward"></mat-icon>
              </button>
            </div>
          </div>
        </mat-step>
      </mat-vertical-stepper>
    </div>
  </div>
  
  <!-- Section des contacts -->
  <div *ngIf="!propertyStore.loading()"
    class="flex-none max-w-unset md:max-w-xs w-full md:ltr:ml-6 md:rtl:mr-6 mt-6 md:mt-0">
    <div class="bg-foreground overflow-hidden">
      <div class="px-6 py-4 border-b">
        <h2 class="title m-0">{{ 'CHECKIN.CONTACT_TITLE' | translate }}</h2>
      </div>

      <div class="px-6 py-3">
        <div *ngFor="let contact of item.checkinContacts" class="py-3 flex items-center">
          <div
            @scaleIn
            class="w-10 h-10 rounded-full bg-primary-600/10 text-primary-600 ltr:mr-3 rtl:ml-3 flex items-center justify-center">
            <mat-icon *ngIf="contact.icon" class="icon-sm" [svgIcon]="contact.icon"></mat-icon>
          </div>

          <div @fadeInRight>
            <p class="m-0 body-1">{{contact.value}}</p>
            <p class="m-0 caption text-hint">{{contact.label}}</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- État de chargement global -->
<div *ngIf="propertyStore.loading() && !hasError" class="flex flex-col items-center justify-center py-12">
  <mat-spinner [diameter]="40"></mat-spinner>
  <p class="mt-4 text-hint">{{ 'COMMON.LOADING' | translate }}</p>
</div>
